import mongoose from 'mongoose';
import User from './src/models/user.js';
import { initializeDefaultData } from './src/utils/defaultData.js';

// Configuration MongoDB
const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/mybudget';

async function addDefaultDataToExistingUsers() {
  try {
    console.log('üîÑ Connexion √† MongoDB...');
    await mongoose.connect(MONGODB_URI);
    console.log('‚úÖ Connect√© √† MongoDB');

    // R√©cup√©rer tous les utilisateurs
    const users = await User.find({});
    console.log(`üìä ${users.length} utilisateur(s) trouv√©(s)`);

    let processed = 0;
    let success = 0;
    let errors = 0;

    for (const user of users) {
      try {
        console.log(`\nüîÑ Traitement de l'utilisateur: ${user.name} (${user.email})`);
        
        const result = await initializeDefaultData(user._id);
        
        if (result.success) {
          console.log(`‚úÖ Donn√©es ajout√©es: ${result.categoriesCreated} cat√©gories, ${result.walletsCreated} portefeuilles`);
          success++;
        } else {
          console.log(`‚ö†Ô∏è Aucune donn√©e ajout√©e: ${result.message}`);
        }
        
        processed++;
        
      } catch (error) {
        console.error(`‚ùå Erreur pour ${user.name}:`, error.message);
        errors++;
      }
    }

    console.log('\nüìä R√©sum√©:');
    console.log(`  - Utilisateurs trait√©s: ${processed}`);
    console.log(`  - Succ√®s: ${success}`);
    console.log(`  - Erreurs: ${errors}`);

  } catch (error) {
    console.error('‚ùå Erreur g√©n√©rale:', error);
  } finally {
    await mongoose.disconnect();
    console.log('üîå D√©connect√© de MongoDB');
  }
}

// Ex√©cuter le script
addDefaultDataToExistingUsers();
