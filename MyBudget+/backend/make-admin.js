import mongoose from 'mongoose';
import 'dotenv/config';
import User from './src/models/user.js';

const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/mybudget';

async function makeUserAdmin() {
  try {
    // Connexion √† MongoDB
    console.log('üîå Connexion √† MongoDB...');
    await mongoose.connect(MONGODB_URI);
    console.log('‚úÖ Connect√© √† MongoDB\n');

    // Demander l'email de l'utilisateur
    const email = process.argv[2];
    
    if (!email) {
      console.log('‚ùå Usage: node make-admin.js <email>');
      console.log('   Exemple: node make-admin.js ouinsoul5@gmail.com');
      process.exit(1);
    }

    // Chercher l'utilisateur
    console.log(`üîç Recherche de l'utilisateur: ${email}`);
    const user = await User.findOne({ email: email.toLowerCase() });

    if (!user) {
      console.log(`‚ùå Utilisateur non trouv√©: ${email}`);
      console.log('\nüìã Liste des utilisateurs disponibles:');
      const allUsers = await User.find({}, 'email name role');
      allUsers.forEach(u => {
        console.log(`   - ${u.email} (${u.name}) - R√¥le: ${u.role}`);
      });
      process.exit(1);
    }

    // V√©rifier si d√©j√† admin
    if (user.role === 'admin') {
      console.log(`‚úÖ ${user.email} est d√©j√† administrateur !`);
      console.log(`   Nom: ${user.name}`);
      console.log(`   R√¥le: ${user.role}`);
      process.exit(0);
    }

    // Mettre √† jour le r√¥le
    console.log(`üîÑ Mise √† jour du r√¥le de ${user.email}...`);
    user.role = 'admin';
    await user.save();

    console.log(`\n‚úÖ ${user.email} est maintenant administrateur !`);
    console.log(`   Nom: ${user.name}`);
    console.log(`   Ancien r√¥le: user`);
    console.log(`   Nouveau r√¥le: ${user.role}`);
    console.log(`\nüéâ Vous pouvez maintenant acc√©der √† la page admin !`);

  } catch (error) {
    console.error('‚ùå Erreur:', error.message);
  } finally {
    await mongoose.connection.close();
    console.log('\nüîå D√©connect√© de MongoDB');
  }
}

makeUserAdmin();

