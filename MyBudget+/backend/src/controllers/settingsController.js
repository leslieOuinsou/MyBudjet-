import UserPreferences from '../models/userPreferences.js';
import User from '../models/user.js';
import bcrypt from 'bcrypt';

// R√©cup√©rer les pr√©f√©rences de l'utilisateur
export const getUserPreferences = async (req, res) => {
  try {
    const userId = req.user._id;
    const preferences = await UserPreferences.getOrCreatePreferences(userId);
    res.json(preferences);
  } catch (error) {
    console.error('Erreur lors de la r√©cup√©ration des pr√©f√©rences:', error);
    res.status(500).json({ message: 'Erreur serveur' });
  }
};

// Mettre √† jour les pr√©f√©rences de l'utilisateur
export const updateUserPreferences = async (req, res) => {
  try {
    const userId = req.user._id;
    
    console.log('üìù Mise √† jour des pr√©f√©rences pour user:', userId);
    console.log('üì¶ Donn√©es re√ßues:', JSON.stringify(req.body, null, 2));

    let userPreferences = await UserPreferences.getOrCreatePreferences(userId);
    
    console.log('üìã Pr√©f√©rences actuelles:', JSON.stringify(userPreferences.toObject(), null, 2));
    
    // Mise √† jour de toutes les cat√©gories envoy√©es
    for (const [category, newSettings] of Object.entries(req.body)) {
      if (userPreferences[category] !== undefined) {
        console.log(`‚úèÔ∏è Mise √† jour de ${category}:`, newSettings);
        await userPreferences.updatePreferences(category, newSettings);
      }
    }

    // Recharger pour obtenir les derni√®res donn√©es
    userPreferences = await UserPreferences.findOne({ user: userId });
    
    console.log('‚úÖ Pr√©f√©rences mises √† jour:', JSON.stringify(userPreferences.toObject(), null, 2));

    res.json(userPreferences);
  } catch (error) {
    console.error('‚ùå Erreur lors de la mise √† jour des pr√©f√©rences:', error);
    res.status(500).json({ message: 'Erreur serveur', error: error.message });
  }
};

// Changer le mot de passe
export const changePassword = async (req, res) => {
  try {
    const { currentPassword, newPassword } = req.body;
    const userId = req.user._id;

    if (!currentPassword || !newPassword) {
      return res.status(400).json({ message: 'Mot de passe actuel et nouveau mot de passe requis' });
    }

    const user = await User.findById(userId);
    if (!user) {
      return res.status(404).json({ message: 'Utilisateur non trouv√©' });
    }

    // V√©rifier le mot de passe actuel
    const isCurrentPasswordValid = await bcrypt.compare(currentPassword, user.password);
    if (!isCurrentPasswordValid) {
      return res.status(400).json({ message: 'Mot de passe actuel incorrect' });
    }

    // Hacher le nouveau mot de passe
    const hashedNewPassword = await bcrypt.hash(newPassword, 10);
    user.password = hashedNewPassword;
    await user.save();

    res.json({ message: 'Mot de passe mis √† jour avec succ√®s' });
  } catch (error) {
    console.error('Erreur lors du changement de mot de passe:', error);
    res.status(500).json({ message: 'Erreur serveur' });
  }
};

// Mettre √† jour les informations de profil
export const updateProfile = async (req, res) => {
  try {
    const { name, email, phoneNumber } = req.body;
    const userId = req.user._id;

    const updateData = {};
    if (name) updateData.name = name;
    if (email) updateData.email = email;
    if (phoneNumber) updateData.phoneNumber = phoneNumber;

    const user = await User.findByIdAndUpdate(
      userId,
      updateData,
      { new: true, select: '-password' }
    );

    if (!user) {
      return res.status(404).json({ message: 'Utilisateur non trouv√©' });
    }

    res.json(user);
  } catch (error) {
    console.error('Erreur lors de la mise √† jour du profil:', error);
    res.status(500).json({ message: 'Erreur serveur' });
  }
};

// Supprimer le compte
export const deleteAccount = async (req, res) => {
  try {
    const { password, confirmation } = req.body;
    const userId = req.user._id;

    if (confirmation !== 'DELETE') {
      return res.status(400).json({ message: 'Confirmation incorrecte' });
    }

    const user = await User.findById(userId);
    if (!user) {
      return res.status(404).json({ message: 'Utilisateur non trouv√©' });
    }

    // V√©rifier le mot de passe
    const isPasswordValid = await bcrypt.compare(password, user.password);
    if (!isPasswordValid) {
      return res.status(400).json({ message: 'Mot de passe incorrect' });
    }

    // Supprimer l'utilisateur et ses donn√©es associ√©es
    await User.findByIdAndDelete(userId);
    await UserPreferences.findOneAndDelete({ user: userId });

    res.json({ message: 'Compte supprim√© avec succ√®s' });
  } catch (error) {
    console.error('Erreur lors de la suppression du compte:', error);
    res.status(500).json({ message: 'Erreur serveur' });
  }
};

// Exporter les donn√©es utilisateur
export const exportUserData = async (req, res) => {
  try {
    const userId = req.user._id;
    
    const user = await User.findById(userId).select('-password');
    const preferences = await UserPreferences.findOne({ user: userId });

    const exportData = {
      user: user,
      preferences: preferences,
      exportDate: new Date().toISOString(),
      version: '1.0'
    };

    res.json(exportData);
  } catch (error) {
    console.error('Erreur lors de l\'export des donn√©es:', error);
    res.status(500).json({ message: 'Erreur serveur' });
  }
};

// Uploader une photo de profil
export const uploadProfilePicture = async (req, res) => {
  try {
    const userId = req.user._id;

    if (!req.file) {
      return res.status(400).json({ message: 'Aucun fichier upload√©' });
    }

    // Construire l'URL de l'image
    const profilePictureUrl = `/uploads/${req.file.filename}`;

    // Mettre √† jour l'utilisateur
    const user = await User.findByIdAndUpdate(
      userId,
      { profilePicture: profilePictureUrl },
      { new: true, select: '-password' }
    );

    if (!user) {
      return res.status(404).json({ message: 'Utilisateur non trouv√©' });
    }

    res.json({ 
      message: 'Photo de profil mise √† jour avec succ√®s',
      profilePicture: profilePictureUrl,
      user
    });
  } catch (error) {
    console.error('Erreur lors de l\'upload de la photo:', error);
    res.status(500).json({ message: 'Erreur serveur' });
  }
};
